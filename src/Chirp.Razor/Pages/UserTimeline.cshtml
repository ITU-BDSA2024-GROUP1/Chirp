@page "/{author}"
@model Chirp.Razor.Pages.UserTimelineModel
@{
    ViewData["Title"] = "Chirp!";
    Layout = "Shared/_Layout";
    var routeName = HttpContext.GetRouteValue("author");
}

<div>
    <h2> @routeName's Timeline </h2>
    @if (User.Identity.IsAuthenticated)
	{
		<div class="cheepbox" style="min-height: 60px">
			<h3>What's on your mind @(User.Identity.Name)?</h3>
			<form method="post">
				<input id="cheepText" style="float: left" type="text" asp-for="Text">
				<p id="charCount" style="float: left">160 characters remaining</p>
				<input id="btnShare" type="submit" value="Share" disabled>
			</form>
		</div>
		<script>
			document.getElementById('cheepText').addEventListener('input', function () {
				const maxLength = 160;
				const remaining = maxLength - this.value.length;
				document.getElementById('charCount').innerText = remaining + ' characters remaining';

				// https://stackoverflow.com/a/13831737
				if (remaining == 160) document.getElementById("btnShare").disabled = true;
				else document.getElementById("btnShare").disabled = false;
			});
		</script>
	}
	@if (Model.Cheeps.Any())
    {
        <ul id="messagelist" class="cheeps">
            <script>
            @Model.incrementer;
            </script>
            
            @foreach (var cheep in Model.Cheeps)
            {
                <li>
                    <p style="word-wrap:break-word;">

                        @if (User.Identity.IsAuthenticated && !User.Identity.Name!.Equals(cheep.Author))
                        {
                            @if (await Model.AFollowsBAsync(User.Identity.Name, cheep.Author)) Model.FollowOrUnfollow = "Unfollow";
                            else Model.FollowOrUnfollow = "Follow";
                            <form method="post">
                                <strong>
                                    <a href="/@cheep.Author">@cheep.Author</a>
                                </strong>
                                <input type="hidden" name="cheepAuthor" value="@cheep.Author"/>
                                <button type="submit" asp-page-handler="ChangeFollowStatus">@Model.FollowOrUnfollow</button>
                            </form>
                        }
                        else
                        {
                            <strong>
                                <a href="/@cheep.Author">@cheep.Author</a>
                            </strong>
                        }
                        <br/>
                        <p id="edit_@Model.incrementer">
                            @cheep.Message
                        </p>
                        <br/>
                        <small>&mdash; @cheep.Timestamp</small>
                        @if (User.Identity.IsAuthenticated && User.Identity.Name!.Equals(cheep.Author))
                        {
                            <form method="post">
                                <input type="hidden" name="cheepAuthor" value="@cheep.Author"/>
                                <input type="hidden" name="cheepMessage" value="@cheep.Message"/>
                                <input type="hidden" name="cheepTimestamp" value="@cheep.Timestamp"/>
                                <button type="submit" asp-page-handler="DeleteCheep">Delete</button>
                            </form>

                            <form method="post" asp-page-handler ="EditCheep">
                                <input type="hidden" name="cheepAuthor" value="@cheep.Author"/>
                                <input type="hidden" name="originalCheepMessage" value="@cheep.Message"/>
                                <input type="hidden" name="timeStamp" value="@cheep.Timestamp"/>
                                <input type="hidden" id="editedCheepMessage_@Model.incrementer" name="cheepMessage" value=""/>
                                <button type="button" id="edit-button_@Model.incrementer">Edit</button>
                                <button type="submit" id="end-editing_@Model.incrementer">Done</button>
                            </form>
                            <script>
                                // Generate unique IDs dynamically
                                var editButton = document.getElementById("edit-button_@Model.incrementer");
                                var endButton = document.getElementById("end-editing_@Model.incrementer");
                                var paragraph = document.getElementById("edit_@Model.incrementer");
                                var editedCheepMessageInput = document.getElementById("editedCheepMessage_@Model.incrementer");
                                console.log(editButton);
                                editButton.addEventListener("click", function () {
                                paragraph.contentEditable = true;
                                paragraph.style.backgroundColor = "#dddbdb";
                                });

                                endButton.addEventListener("click", function () {
                                paragraph.contentEditable = false;
                                paragraph.style.backgroundColor = "#f0faf9";
                                editedCheepMessageInput.value = paragraph.innerText.trim();
                                });
                            </script>
                        }
                    </p>
                </li>
                <script>
                @Model.increment();
                </script>
            }
        </ul>

        <nav aria-label="Page navigation">
            <ul style="list-style-type: none; padding: 0; display: flex; justify-content: center;">
                @if (Model.CurrentPage > 1)
                {
                    <li style="margin: 0 5px;">
                        <a href="/@Model.RouteData.Values["author"]?page=@(Model.CurrentPage - 1)" aria-label="Previous" style="padding: 0.5em 1em; border: 1px solid #ddd; text-decoration: none;">&laquo;</a>
                    </li>
                }

                @if (Model.CurrentPage > 3)
                {
                    <li style="margin: 0 5px;">
                        <a href="/@Model.RouteData.Values["author"]?page=1" style="padding: 0.5em 1em; border: 1px solid #ddd; text-decoration: none;">1</a>
                    </li>
                    <li style="margin: 0 5px;">
                        <span style="padding: 0.5em 1em; border: 1px solid #ddd;">...</span>
                    </li>
                }

                @for (var i = Math.Max(1, Model.CurrentPage - 2); i <= Math.Min(Model.TotalPages, Model.CurrentPage + 2); i++)
                {
                    <li style="margin: 0 5px;" class="@(Model.CurrentPage == i ? "active" : "")">
                        <a href="/@Model.RouteData.Values["author"]?page=@i" style="padding: 0.5em 1em; border: 1px solid #ddd; text-decoration: none;">@i</a>
                    </li>
                }

                @if (Model.CurrentPage < Model.TotalPages - 2)
                {
                    <li style="margin: 0 5px;">
                        <span style="padding: 0.5em 1em; border: 1px solid #ddd;">...</span>
                    </li>
                    <li style="margin: 0 5px;">
                        <a href="/@Model.RouteData.Values["author"]?page=@Model.TotalPages" style="padding: 0.5em 1em; border: 1px solid #ddd; text-decoration: none;">@Model.TotalPages</a>
                    </li>
                }

                @if (Model.CurrentPage < Model.TotalPages)
                {
                    <li style="margin: 0 5px;">
                        <a href="/@Model.RouteData.Values["author"]?page=@(Model.CurrentPage + 1)" aria-label="Next" style="padding: 0.5em 1em; border: 1px solid #ddd; text-decoration: none;">&raquo;</a>
                    </li>
                }
            </ul>
        </nav>
    }
    else
    {
        <em>There are no cheeps so far.</em>
    }
</div>
